# 設計書：ブラウザ操作 Record/Replay テストツール（Python + Playwright codegen）

## 1. 目的

ユーザーが行ったブラウザ操作を記録し、同一操作を繰り返し自動実行できる仕組みを提供する。
運用対象はまず Angular（SPA）を中心とし、JS生成UI（ドロップダウン、オーバーレイ）や Wijmo（Combo/Grid 等）でも安定して動作することを最優先とする。
記録結果は「人間が読める」「手書きで簡単に編集できる」「全体の流れが把握できる」ことを重視する。

## 2. 達成要件（機能）

### 2.1 Record/Import

* Playwright `codegen` を利用して操作を記録（Playwright管理下ブラウザ）
* `codegen` 生成の Python スクリプトを **読みやすい YAML DSL** に自動変換（import）
* import 時に以下を自動付与できること

  * ステップ名（`name`）と `section`（章立て）
  * セレクタの正規化（role/testId/css など）
  * 基本的な `expect`（少なくとも画面の要素表示待ち）を補助的に挿入可能

### 2.2 Replay（実行）

* YAML DSL を読み込み、Python Playwright で実行
* Angular/SPA の描画揺らぎに強い（auto-wait + expect中心）
* セレクタ解決は単一に依存せず、複数候補フォールバック（`any`）を標準化
* `strict` デフォルト ON（誤クリック回避）

### 2.3 編集性（手書き/AI）

* 1行追加でスクショ、待機、ログ、検証を差し込み可能
* `section` で全体意図が読める
* 変数（`${env.X}` / `${vars.X}`）と秘密値（`secret: true`）を標準サポート
* AIで DSL を生成/整形できる仕組み（CLIコマンドとして提供、スキーマで制約）

### 2.4 Wijmo / JS生成UI対応（高レベルステップ）

最低限ではなく「実運用で必要な範囲」を標準搭載する（後述）。

### 2.5 成果物（アーティファクト）

* スクリーンショット：**毎ステップ必須（before_each_step）**
* トレース：**失敗時必須（on_failure）**
* 動画：**失敗時必須（on_failure）**
* 失敗時に「どこで何が起きたか」を即時に追えるディレクトリ構成とレポートを提供

---

## 3. 非機能要件

* 安定性：SPA・オーバーレイ・仮想スクロールでも破綻しにくい
* 可観測性：失敗時に原因追跡ができる（trace / screenshot / logs / optional video）
* 再現性：実行環境（viewport / timezone / locale / storageState 等）を固定可能
* CI適性：JUnit/JSON/HTMLのレポート出力、exit codeの明確化
* 拡張性：ステップ追加をプラグイン方式で増やせる

---

## 4. 全体アーキテクチャ

### 4.1 コンポーネント

1. **Recorder（外部依存）**

* Playwright `codegen`（Pythonターゲット）
* 生成物：`recordings/raw_xxx.py`

2. **Importer（本プロジェクト）**

* `raw_xxx.py` を解析（Python AST）し、YAML DSLに変換
* 生成物：`flows/xxx.yaml`

3. **Runner（本プロジェクト）**

* YAMLを実行し、アーティファクトとレポートを出力
* 生成物：`artifacts/run-YYYYMMDD-HHMMSS/*`

4. **Step Library（本プロジェクト）**

* 標準ステップ + Wijmo/Overlay 等の高レベルステップ群

5. **AI Authoring（本プロジェクト）**

* 自然言語 → YAML
* import後YAMLの整形（section付与、命名、expect補完）
* スキーマ検証により安全に出力

---

## 5. DSL（YAML）仕様

### 5.1 最上位スキーマ（概略）

```yaml
title: "シナリオ名"
baseUrl: "https://example.com"

vars:
  email: "${env.EMAIL}"
  password: "${env.PASSWORD}"

artifacts:
  screenshots:
    mode: "before_each_step"     # before_each_step | before_and_after | none
    format: "jpeg"               # jpeg | png
    quality: 70                  # jpegのみ
  trace:
    mode: "on_failure"           # on_failure | always | none
    screenshots: true
    snapshots: true
    sources: true
  video:
    mode: "on_failure"           # on_failure | always | none
    size: { width: 1280, height: 720 }

hooks:
  beforeEachStep:
    - screenshot: { name: "before-${step.index}-${step.name}" }
  afterEachStep: []              # 任意

steps:
  - section: "ログイン"
  - goto: { url: "${baseUrl}/login", name: "login-page" }
  - fill: { by: { role: "textbox", name: "Email" }, value: "${vars.email}", name: "fill-email" }
  - fill: { by: { role: "textbox", name: "Password" }, value: "${vars.password}", secret: true, name: "fill-password" }
  - click: { by: { role: "button", name: "Login" }, name: "click-login" }
  - expectVisible: { by: { text: "Dashboard" }, name: "dashboard-visible" }
```

### 5.2 `by`（要素指定）仕様（最適デフォルト）

* サポート：`testId`, `role+name`, `label`, `placeholder`, `css`, `text(補助)`, `any(フォールバック)`
* 原則：`any` を持てる設計（1つに賭けない）
* 原則：`strict: true` デフォルト（複数ヒットで失敗）

例：

```yaml
- click:
    by:
      any:
        - { testId: "login-button" }
        - { role: "button", name: "Login" }
        - { css: "[data-testid='login'] button", text: "Login" }
    strict: true
    name: "click-login"
```

### 5.3 ステップ一覧（標準）

* ナビゲーション：`goto`, `back`, `reload`
* 操作：`click`, `dblclick`, `fill`, `press`, `check`, `uncheck`, `selectOption`（HTML select）
* 待機/同期：`waitFor`, `waitForVisible`, `waitForHidden`, `waitForNetworkIdle`（必要時のみ）
* 検証：`expectVisible`, `expectHidden`, `expectText`, `expectUrl`
* 取得：`storeText`（varsへ格納）, `storeAttr`
* デバッグ：`screenshot`, `log`, `dumpDom`（失敗時のみなど制御可）
* セッション：`useStorageState`, `saveStorageState`（ログイン短縮）

---

## 6. 高レベルステップ（全対応方針）

### 6.1 Overlay/JS生成UI（汎用）

#### `selectOverlayOption`

用途：Angular Material / Wijmo / 汎用オーバーレイの「開く→候補出る→選ぶ」を1ステップ化。

```yaml
- selectOverlayOption:
    open: { by: { testId: "status-combo" } }
    list: { by: { css: ".wj-listbox, .cdk-overlay-pane, [role='listbox']" } }
    optionText: "Active"
    name: "select-status"
```

内部動作：

1. openをclick
2. listの可視化を待つ（expectVisible相当）
3. list内から optionText を含む候補を strict に特定して click
4. listが閉じたことを確認（任意）

### 6.2 Wijmo Combo（専用）

#### `selectWijmoCombo`

* root（コンポーネント境界）を指定し、その配下の `.wj-input` 等を利用して安定化
* 候補リストのクラス体系（`.wj-listbox-item` 等）に最適化

```yaml
- selectWijmoCombo:
    root: { by: { testId: "status-combo" } }
    optionText: "Active"
    name: "wijmo-status-active"
```

### 6.3 Wijmo Grid（専用）

#### `clickWijmoGridCell`

座標クリック禁止（壊れやすい）を前提に、行はキーで特定、列は列名で特定。

```yaml
- clickWijmoGridCell:
    grid: { by: { testId: "orders-grid" } }
    rowKey: { column: "OrderId", equals: "12345" }
    column: "Status"
    name: "grid-click-status"
```

内部動作（仮想スクロール対応）：

1. グリッド要素取得
2. ヘッダから列インデックス特定（列名一致）
3. rowKey条件に一致する行を探索（見つからなければスクロールして探索）
4. 特定セルを click
5. 必要ならセル編集モード開始・確定等も派生ステップで提供

### 6.4 追加で標準搭載する高レベルステップ（推奨）

* `setDatePicker`（UI日付ピッカー全般）
* `uploadFile`（input[type=file]やUIボタン経由）
* `waitForToast`（トースト/通知の出現・消滅）
* `assertNoConsoleError`（console error検知）
* `apiMock` / `routeStub`（Playwright routeでAPIスタブ、E2E安定化用途）

---

## 7. Runner（実行エンジン）設計

### 7.1 実行ライフサイクル

1. config読込（viewport/locale/timezone/headers/storageState等）
2. Browser/Context生成（動画設定はContextに付与）
3. trace開始（always or on_failure運用に合わせて）
4. ステップループ

   * `beforeEachStep` 実行（スクショ等）
   * ステップ本体
   * `afterEachStep` 実行
5. 成否で成果物保持/破棄（trace/videoのon_failure運用）
6. レポート生成（概要、失敗ステップ、添付ファイルへのリンク）

### 7.2 Angular/SPA安定化戦略

* 基本：Playwright locator の auto-wait + expect を前提
* `goto` 後は `waitForLoadState("domcontentloaded")` を標準
* Overlay系は `expectVisible(list)` を必須に近い形で内部挿入
* “成功条件”は常に `expect` で表現できるように DSL を設計する

### 7.3 セレクタ解決（最重要）

* `by.any` は上から試し、**visible かつ strict(=1件)** を満たしたものを採用
* strict不一致は即失敗（誤操作防止）
* `text` 単体指定は原則禁止（lintで警告）

  * ただし `css + text` / `role + name` の補助条件としては許可

### 7.4 自己修復（任意機能だが“全対応”方針なら搭載）

* `healing: off|safe` をシナリオ単位で設定
* safeモードでは以下のみ許可

  * any候補の別セレクタを試す
  * testId/role/name/label の範囲で再解決
* DOM近傍探索など“推測クリック”はデフォルト禁止（誤クリックリスクが高い）

---

## 8. アーティファクト設計

### 8.1 既定（最適）

* screenshot：`before_each_step`（必須）
* trace：`on_failure`（必須）
* video：`on_failure`（必須）

### 8.2 ディレクトリ構成

```
artifacts/
  run-20260222-120000/
    flow.yaml
    env.json              # マスク済み
    report.json
    report.html
    screenshots/
      0001_before-fill-email.jpg
      0002_before-fill-password.jpg
      ...
    trace/
      trace.zip           # 失敗時のみ
    video/
      <auto>.webm         # 失敗時のみ
    logs/
      runner.log
      console.log
```

### 8.3 動画は簡単か

* PlaywrightはContext作成時に `record_video_dir` を設定するだけで録画可能
* “失敗時のみ保存”は、成功時に `page.video.path()` を取得して削除する運用で実現

---

## 9. Importer（codegen→YAML）設計

### 9.1 入力

* `playwright codegen --target python -o recordings/raw_xxx.py <url>`

### 9.2 解析方式

* Python ASTで以下を抽出

  * `page.goto(...)` → `goto`
  * `page.get_by_role(...).click()` → `click`（role/name）
  * `page.get_by_test_id(...).click()` → `click`（testId）
  * `page.locator("...").fill("...")` → `fill`（css/locator）
  * `expect(...)` → `expectVisible/expectText` 等へマップ（可能な範囲）
* locator文字列の正規化（`css=` プレフィックス等を吸収）
* 連続する類似操作を1つのsectionにまとめるヒューリスティック

  * `goto / login` を検知して「ログイン」sectionを生成
  * URLパスやボタン文言から section 名を推定

### 9.3 出力補助（読みやすさ）

* 各ステップに `name` を自動付与（動詞-目的語の短い形式）
* 重要操作後に `expectVisible` を補助挿入（オプション）
* `secret` 判定（Password等のフィールド名・role/nameから推定し警告）

---

## 10. AI Authoring（全対応）

### 10.1 機能

* `ai draft`：自然言語仕様 → YAML生成（スキーマ準拠）
* `ai refine`：importしたYAMLを、section/命名/expect補強/重複整理
* `ai explain`：YAMLからアウトライン（章立てと要点）を生成

### 10.2 安全策

* 出力は必ずスキーマ検証（Pydantic/JSON Schema）
* 禁止パターン（text単体selector等）はlintで警告または失敗
* `secret: true` は必ず保持（ログやreportでマスク）

---

## 11. CLI設計（例）

* `init`：プロジェクト雛形生成
* `record <url>`：codegen起動（raw.py保存先指定）
* `import recordings/raw_xxx.py -o flows/xxx.yaml`
* `run flows/xxx.yaml --headed/--headless --workers N`
* `validate flows/xxx.yaml`：スキーマ検証
* `lint flows/xxx.yaml`：セレクタ危険度やanti-pattern検出
* `report artifacts/run-...`：HTML再生成
* `list-steps`：利用可能なステップ一覧（高レベル含む）
* `ai draft/refine/explain ...`：AI支援

---

## 12. 実装構成（Python）

### 12.1 推奨ライブラリ

* Playwright Python
* Pydantic（DSLスキーマ/検証）
* ruamel.yaml（YAMLのコメント保持/整形）
* Typer（CLI）
* Jinja2（HTMLレポート）
* pytest（本ツール自身のテスト）

### 12.2 リポジトリ構造（例）

```
tool/
  src/
    core/
      runner.py
      selector.py
      artifacts.py
      reporting.py
      waits.py
    dsl/
      schema.py
      parser.py
      linter.py
    steps/
      builtin.py
      overlay.py
      wijmo_combo.py
      wijmo_grid.py
      datepicker.py
      upload.py
    importer/
      py_ast_parser.py
      mapper.py
      heuristics.py
    ai/
      draft.py
      refine.py
      prompts.py
  templates/
    report.html.j2
  examples/
    flows/
  tests/
```

---

## 13. テスト戦略（ツール自身）

* DSLスキーマ検証テスト
* セレクタ解決（strict/any/visibility）ユニットテスト
* Importer（raw.py→yaml）変換テスト（固定フィクスチャ）
* Wijmo高レベルステップのE2E（デモページ/モックHTMLで再現）
* アーティファクトのon_failure挙動（成功時に動画が残らない等）

---

## 14. デフォルト方針（本設計の結論）

* `by`：`testId` → `role/name` → `label/placeholder` → `css(+text補助)`、`any` と `strict` を標準化
* 高レベル：Overlay汎用 + Wijmo Combo + Wijmo Grid を標準搭載し、日付/アップロード/トースト等も同梱
* 成果物：**毎ステップスクショ必須** + **失敗時トレース必須** + **失敗時動画必須**（成功時は削除）
* 記録：codegenを採用し、運用はYAML DSL（importで翻訳）

---

## 付録：アーティファクト設定（推奨のまま）

```yaml
artifacts:
  screenshots:
    mode: "before_each_step"
    format: "jpeg"
    quality: 70
  trace:
    mode: "on_failure"
    screenshots: true
    snapshots: true
    sources: true
  video:
    mode: "on_failure"
    size: { width: 1280, height: 720 }
```
